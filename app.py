from flask import Flask, render_template, request, redirect, url_for, session, flash
import os

app = Flask(__name__)
app.secret_key = os.environ.get("SECRET_KEY", "dev-secret")

USERNAME = 'Arailym'
PASSWORD = '2005'

port = int(os.environ.get("PORT", 5001))

CORRECT_ANSWERS = {
    'q1': 'a',
    'q2': 'a',
    'q3': 'a',
    'q4': 'c',
    'q5': 'a',
    'q6': 'd',
    'q7': 'c',
    'q8': 'b',
    'q9': 'd',
    'q10': 'b',
    'q11': 'a',
    'q12': 'c',
    'q13': 'b',
    'q14': 'd',
    'q15': 'c',
    'q16': 'a',
    'q17': 'b',
    'q18': 'd',
    'q19': 'a',
    'q20': 'c',
    'q21': 'b',
    'q22': 'd',
    'q23': 'a',
    'q24': 'c',
    'q25': 'b',
    'q26': 'd',
    'q27': 'a',
    'q28': 'c',
    'q29': 'b',
    'q30': 'd',
    'q31': 'a',
    'q32': 'b',
    'q33': 'c',
    'q34': 'a',
    'q35': 'b',
    'q36': 'c',
    'q37': 'a',
    'q38': 'b',
    'q39': 'd',
    'q40': 'c',
    'q41': 'a',
    'q42': 'b',
    'q43': 'd',
    'q44': 'c',
    'q45': 'b',
    'q46': 'd',
    'q47': 'a',
    'q48': 'b',
    'q49': 'c',
    'q50': 'a',
}


@app.route('/')
def home():
    print("Home route accessed")
    return redirect(url_for('login'))


@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        username = request.form.get('username')
        password = request.form.get('password')
        if username == USERNAME and password == PASSWORD:
            session['username'] = username
            flash('Login successful!', 'success')
            return redirect(url_for('quiz', question=1))
        else:
            flash('Invalid credentials.', 'danger')
    return render_template('login.html')


@app.route('/quiz/<int:question>', methods=['GET', 'POST'])
def quiz(question):
    if 'username' not in session:
        return redirect(url_for('login'))

    questions = {
        1: {
            "text": "Медициналық деонтология дегеніміз ... туралы iлiм.",
            "options": {'a': 'кәсіби мiндет, адамгершілік, мораль',
                        'b': 'дәрiгерлiк құпия',
                        'c': 'адамды рухани тұрғыдан тәрбиелеу',
                        'd': 'қоршаған ортаның көркемдігі',
                        'e': 'халық арасындағы адамгершілік'}
        },
        2: {
            "text": "Стационардағы бөлімшенің құрылымына кіреді:",
            "options": {'a': 'қабылдау және емдік бөлімшелер',
                        'b': 'тіркеу болімі және дені сау бала бөлмесі',
                        'c': 'профилактикалық бөлімше және егу бөлмесі',
                        'd': 'дені сау бала бөлмесі және диагностикалық бөлімше',
                        'e': 'қабылдау бөлімі және жасөспірім бөлмесі'}
        },
        3: {
            "text": "Пациенттердің қауіпсіздігінің алты халықаралық мақсатын көрсетіңіз:",
            "options": {
                'a': 'сәйкестендіру, тиімді байланыс, жоғары қауіпті дәрі-дәрмектер, верификация, қол гигиенасы, құлаудың алдын алу',
                'b': 'сәйкестендіру кодтары, ақпарат беру, жоғары қауіпті дәрі-дәрмектерді басқару, верификация, қол гигиенасы, құлаудың алдын алу',
                'c': 'сәйкестендіру, тиімді коммуникация, жоғары қауіпті дәрі-дәрмектерді басқару, верификация және тайм-аут, қол гигиенасы, құлаудың алдын алу',
                'd': 'сәйкестендіру, тиімді байланыс, жоғары қауіпті дәрі-дәрмектерді басқару, тексеру, қол гигиенасы, құлаудың алдын алу',
                'e': 'дұрыс жауап жоқ'}
        },
        4: {
            "text": "\"Зиян келтіру дәрігердің этикалық қателігі ...\"",
            "options": {'a': 'бұл құқық бұзушылық емес',
                        'b': 'құқық бұзушылық',
                        'c': 'жекелеген жағдайларға байланысты болуы мүмкін'}
        },
        5: {
            "text": "Медициналық қызметтің негізгі принциптері қандай?",
            "options": {'a': 'құпиялылық, пациенттің құқығы, кәсіби этика',
                        'b': 'білім беру, құқық қорғау, қоғамдық денсаулық',
                        'c': 'эксперименттік емдеу, пациентті бақылау',
                        'd': 'қолдау көрсету, қаржылық көмек'}
        },
        6: {
            "text": "Госпитализация кезінде пациенттің құқығы қандай?",
            "options": {'a': 'пациенттің емделу әдістерін таңдау құқығы',
                        'b': 'дәрігердің шешіміне қарсы шығу құқығы',
                        'c': 'тек қана белгілі бір емдеу тәсілін қабылдау',
                        'd': 'емдеуге қатысты кез келген шешім қабылдау'}
        },
        7: {
            "text": "Қауіпсіздік шараларының негізгі аспектілері:",
            "options": {'a': 'санитарлық нормалар мен стандарттар',
                        'b': 'қабылдау қызметкерлерінің біліктілігі',
                        'c': 'дәрігерлердің кәсіби тәжірибесі',
                        'd': 'медициналық құралдардың сапасы'}
        },
        8: {
            "text": "Паллиативтік көмек қандай жағдайда қажет?",
            "options": {'a': 'жазылмайтын ауруларға шалдыққан пациенттерге',
                        'b': 'жедел жағдайларда',
                        'c': 'балаларға арналған ауруханаларда',
                        'd': 'қосымша тесттер мен сараптамалар қажет болғанда'}
        },
        9: {
            "text": "Психиатриялық көмек көрсету кезінде қандай принциптер маңызды?",
            "options": {'a': 'пациенттің ерікті келісімі',
                        'b': 'тек қана дәрі-дәрмектер қолдану',
                        'c': 'пациенттің жанұясының келісімі',
                        'd': 'жедел арада операция жасау'}
        },
        10: {
            "text": "Пациентті емдеу кезінде не нәрсеге ерекше назар аударылады?",
            "options": {'a': 'пациенттің психоэмоционалды жағдайы',
                        'b': 'жұмыс уақытының ұзақтығы',
                        'c': 'емдеу әдісінің қымбатшылығы',
                        'd': 'дәрігердің жұмыс графигі'}
        },
        11: {
            "text": "Қауіпсіздік шараларын бұзған жағдайда не болады?",
            "options": {'a': 'жұмыстан босату',
                        'b': 'құқықтық жауапкершілік',
                        'c': 'қоғамдық жұмысқа тарту',
                        'd': 'қосымша терапия'}
        },
        12: {
            "text": "Психиатриялық көмек көрсету кезінде қандай принциптер маңызды?",
            "options": {
                "a": "пациенттің ерікті келісімі",
                "b": "тек қана дәрі-дәрмектер қолдану",
                "c": "пациенттің жанұясының келісімі",
                "d": "жедел арада операция жасау"
            }
        },
        13: {
            "text": "Пациентті емдеу кезінде не нәрсеге ерекше назар аударылады?",
            "options": {
                "a": "пациенттің психоэмоционалды жағдайы",
                "b": "жұмыс уақытының ұзақтығы",
                "c": "емдеу әдісінің қымбатшылығы",
                "d": "дәрігердің жұмыс графигі"
            }
        },
        14: {
            "text": "Қауіпсіздік шараларын бұзған жағдайда не болады?",
            "options": {
                "a": "жұмыстан босату",
                "b": "құқықтық жауапкершілік",
                "c": "қоғамдық жұмысқа тарту",
                "d": "қосымша терапия"
            }
        },
        15: {
            "text": "Қауіпсіздік шараларының негізгі аспектілері:",
            "options": {
                "a": "санитарлық нормалар мен стандарттар",
                "b": "қабылдау қызметкерлерінің біліктілігі",
                "c": "дәрігерлердің кәсіби тәжірибесі",
                "d": "медициналық құралдардың сапасы"
            }
        },
        16: {
            "text": "Госпитализация кезінде пациенттің құқығы қандай?",
            "options": {
                "a": "пациенттің емделу әдістерін таңдау құқығы",
                "b": "дәрігердің шешіміне қарсы шығу құқығы",
                "c": "тек қана белгілі бір емдеу тәсілін қабылдау",
                "d": "емдеуге қатысты кез келген шешім қабылдау"
            }
        },
        17: {
            "text": "Паллиативтік көмек қандай жағдайда қажет?",
            "options": {
                "a": "жазылмайтын ауруларға шалдыққан пациенттерге",
                "b": "жедел жағдайларда",
                "c": "балаларға арналған ауруханаларда",
                "d": "қосымша тесттер мен сараптамалар қажет болғанда"
            }
        },
        18: {
            "text": "Медициналық қызметтің негізгі принциптері қандай?",
            "options": {
                "a": "құпиялылық, пациенттің құқығы, кәсіби этика",
                "b": "білім беру, құқық қорғау, қоғамдық денсаулық",
                "c": "эксперименттік емдеу, пациентті бақылау",
                "d": "қолдау көрсету, қаржылық көмек"
            }
        },
        19: {
            "text": "Зиян келтіру дәрігердің этикалық қателігі ...",
            "options": {
                "a": "бұл құқық бұзушылық емес",
                "b": "құқық бұзушылық",
                "c": "жекелеген жағдайларға байланысты болуы мүмкін"
            }
        },
        20: {
            "text": "Психотерапияның басты мақсаты не?",
            "options": {
                "a": "пациенттің эмоциялық жағдайын қалыпқа келтіру",
                "b": "пациенттің физикалық денсаулығын жақсарту",
                "c": "пациенттің әлеуметтік жағдайын зерттеу",
                "d": "пациентке медициналық көмек көрсету"
            }
        },
        21: {
            "text": "Қоғамдық денсаулықты қорғау мен қауіпсіздік сақтау туралы заңдар қандай іс-шараларды қамтиды?",
            "options": {
                "a": "пациенттер мен қоғам мүшелерінің денсаулығын қорғау",
                "b": "медициналық құрал-жабдықтарды тексеру",
                "c": "экологиялық апаттарды зерттеу",
                "d": "қоғамдық жұмысқа тарту"
            }
        },
        22: {
            "text": "Психоэмоционалдық жағдайды бағалауда қандай әдістер қолдануға болады?",
            "options": {
                "a": "интервью және сауалнама жүргізу",
                "b": "медициналық құралдармен тексеру",
                "c": "тек дәрі-дәрмектер қолдану",
                "d": "ұзақ уақыттық бақылау"
            }
        },
        23: {
            "text": "Пациенттерді медициналық көмектің барлық түрлерімен қамтамасыз ету кезінде қандай құқықтар сақталады?",
            "options": {
                "a": "пациенттің емдеу әдісін таңдау құқығы",
                "b": "дәрігердің барлық шешімдерін қабылдау құқығы",
                "c": "барлық мүмкін болатын дәрі-дәрмектерді қолдану құқығы",
                "d": "қосымша операциялардан бас тарту құқығы"
            }
        },
        24: {
            "text": "Қоғамдық денсаулықты қорғаудың заңдылықтарынан негізгі аспектілер:",
            "options": {
                "a": "құқықтық жауапкершілік",
                "b": "медицина қызметкерлерінің біліктілігі",
                "c": "дәрі-дәрмек саясаты",
                "d": "әлеуметтік жағдайды зерттеу"
            }
        },
        25: {
            "text": "Әлеуметтік дәрігердің басты міндеттері:",
            "options": {
                "a": "әлеуметтік қызметтер көрсету",
                "b": "қоғамдық денсаулық сақтау мәселелерін шешу",
                "c": "жеке тұлғаның мүдделерін қорғау",
                "d": "медициналық құпияларды сақтау"
            }
        },
        26: {
            "text": "Медициналық қызмет көрсету кезінде қандай бақылау шаралары қолданылады?",
            "options": {
                "a": "қызмет көрсету сапасын тексеру",
                "b": "қауіпсіздік шараларын сақтау",
                "c": "қоғамдық жұмыстарды орындау",
                "d": "барлық жауаптар дұрыс"
            }
        },
        27: {
            "text": "Денсаулық сақтау қызметкерінің кәсіби этикасына сәйкес қандай әрекеттерге жол берілмейді?",
            "options": {
                "a": "пациенттің құпиясын ашу",
                "b": "пациенттерге қажетсіз емдеу әдістерін қолдану",
                "c": "барлық жауаптар дұрыс",
                "d": "дәрі-дәрмектерді дұрыс қолданбау"
            }
        },
        28: {
            "text": "Қоғамдық денсаулық сақтау ұйымының басты міндеті қандай?",
            "options": {
                "a": "әлеуметтік қамсыздандыру",
                "b": "қоғамдық денсаулықты қорғау",
                "c": "медициналық бақылауды ұйымдастыру",
                "d": "қоғамдық қызмет көрсету"
            }
        },
        29: {
            "text": "Пациенттерге медициналық көмек көрсетуде қандай этикалық талаптар қойылады?",
            "options": {
                "a": "пациенттің жеке құпиясын сақтау",
                "b": "пациенттің келісімін алу",
                "c": "емдеу әдісін таңдау құқығы",
                "d": "барлық жауаптар дұрыс"
            }
        },
        30: {
            "text": "Қауіпсіздік шараларының тиімділігі неде?",
            "options": {
                "a": "санитарлық нормаларды сақтау",
                "b": "дәрігердің тәжірибесі",
                "c": "әлеуметтік қамсыздандыру",
                "d": "тек медициналық құралдарды пайдалану"
            }
        },
        31: {
            "text": "Қауіпсіздік шараларының негізгі принциптері:",
            "options": {
                "a": "санитарлық нормалар мен стандарттар",
                "b": "қабылдау қызметкерлерінің біліктілігі",
                "c": "дәрігерлердің кәсіби тәжірибесі",
                "d": "медициналық құралдардың сапасы"
            }
        },
        32: {
            "text": "Пациенттің денсаулығына қауіп төніп тұрғанда дәрігер қандай әрекет жасайды?",
            "options": {
                "a": "қосымша тексерулер тағайындайды",
                "b": "жедел көмек көрсетеді",
                "c": "пациентті басқа емханаға жібереді",
                "d": "жақын туыстарымен кеңеседі"
            }
        },
        33: {
            "text": "Қазіргі заманда денсаулық сақтау жүйесінде қандай жаңа технологиялар қолданылады?",
            "options": {
                "a": "роботтық хирургия",
                "b": "аналогтық құралдар",
                "c": "генетикалық зерттеулер",
                "d": "барлық жауаптар дұрыс"
            }
        },
        34: {
            "text": "Дәрігердің пациентке деген қарым-қатынасы қандай болуы керек?",
            "options": {
                "a": "құрметті және сенімді",
                "b": "салқын және формальды",
                "c": "қатаң және қатал",
                "d": "әрдайым жұмсақ және көңіл көтерер"
            }
        },
        35: {
            "text": "Стационарлық емдеуде дәрігер қандай міндеттерді атқарады?",
            "options": {
                "a": "пациентті емдеу",
                "b": "пациенттің жағдайын тұрақты бақылау",
                "c": "пациентке кеңес беру",
                "d": "барлық жауаптар дұрыс"
            }
        },
        36: {
            "text": "Дәрігердің жұмысына қандай факторлар әсер етеді?",
            "options": {
                "a": "пациенттің әлеуметтік жағдайы",
                "b": "медициналық жабдықтар",
                "c": "дәрігердің тәжірибесі",
                "d": "барлық жауаптар дұрыс"
            }
        },
        37: {
            "text": "Пациенттердің қауіпсіздігін қамтамасыз ету үшін қандай стандарттар бар?",
            "options": {
                "a": "құпиялылық пен қауіпсіздікті сақтау",
                "b": "жоғары қауіпті дәрі-дәрмектерді бақылау",
                "c": "қол гигиенасы және сәйкестендіру",
                "d": "барлық жауаптар дұрыс"
            }
        },
        38: {
            "text": "Дәрігерлік қателіктерді азайту үшін қандай әдістер қолданылады?",
            "options": {
                "a": "қатал бақылау және тексерулер",
                "b": "пациенттермен тексерулер жүргізу",
                "c": "емдеу әдістерін жақсарту",
                "d": "барлық жауаптар дұрыс"
            }
        },
        39: {
            "text": "Дәрігерлер мен медбикелер арасындағы қатынастың маңызы қандай?",
            "options": {
                "a": "бұл медициналық көмектің тиімділігін арттырады",
                "b": "дәрігерге тәуелді",
                "c": "медбике дәрігердің орнын алмастырады",
                "d": "пациенттердің қауіпсіздігін қамтамасыз етеді"
            }
        },
        40: {
            "text": "Паллиативтік көмек көрсету кімдер үшін қажет?",
            "options": {
                "a": "ұзақ уақыттық аурулармен ауыратын адамдар үшін",
                "b": "жедел медициналық көмекке мұқтаж пациенттер үшін",
                "c": "балалар үшін",
                "d": "кешенді диагностикалық тексеру қажет болғанда"
            }
        },
        41: {
            "text": "Медициналық көмек көрсету барысында қандай құжаттар қажет?",
            "options": {
                "a": "пациенттің медициналық картасы",
                "b": "пациенттің келісімі",
                "c": "құпия ақпаратты сақтау келісімі",
                "d": "барлық жауаптар дұрыс"
            }
        },
        42: {
            "text": "Медициналық этиканы сақтау кезінде қандай әрекеттер орындалмайды?",
            "options": {
                "a": "пациенттің жеке өміріне араласу",
                "b": "дәрігердің жеке пікірлерін енгізу",
                "c": "құпияны сақтау",
                "d": "барлық жауаптар дұрыс"
            }
        },
        43: {
            "text": "Пациенттің жағдайы өзгерген жағдайда не істеу керек?",
            "options": {
                "a": "дәрігерге хабарлау",
                "b": "қосымша тексерулер жүргізу",
                "c": "пациентті басқа мекемеге жіберу",
                "d": "емдеуді тоқтату"
            }
        },
        44: {
            "text": "Стационарлық емдеуде пациенттерді бақылаудың негізгі аспектісі қандай?",
            "options": {
                "a": "пациенттің психоэмоционалды жағдайын бақылау",
                "b": "қолайлы емдеу тәсілін таңдау",
                "c": "емдеу процесінің үнемі тексерілуі",
                "d": "емдеу әдісінің дәлдігі мен тиімділігі"
            }
        },
        45: {
            "text": "Қоғамдық денсаулықты қорғау үшін қандай іс-шаралар қажет?",
            "options": {
                "a": "медициналық көмек көрсету",
                "b": "санитарлық жағдайды бақылау",
                "c": "қоғамдық аурулардың алдын алу",
                "d": "барлық жауаптар дұрыс"
            }
        },
        46: {
            "text": "Психоэмоционалдық көмек көрсету кезінде басты назар неге аударылады?",
            "options": {
                "a": "пациенттің ішкі жағдайына",
                "b": "емдеу әдісінің таңдауы",
                "c": "пациенттің әлеуметтік жағдайы",
                "d": "белгілі бір дәрі-дәрмектердің қолданылуы"
            }
        },
        47: {
            "text": "Медициналық көмектің сапасын бақылау үшін қандай әдістер қолданылды?",
            "options": {
                "a": "пациенттердің пікірін тыңдау",
                "b": "қызметтердің сапасын бағалау",
                "c": "кәсіби тексерулер өткізу",
                "d": "барлық жауаптар дұрыс"
            }
        },
        48: {
            "text": "Қандай жағдайларда пациентке қосымша медициналық көмек қажет болуы мүмкін?",
            "options": {
                "a": "қосымша зерттеулер мен диагноздар қажет болғанда",
                "b": "қосымша медикаментозды емдеу қажет болғанда",
                "c": "қосымша операциялар қажет болғанда",
                "d": "барлық жауаптар дұрыс"
            }
        },
        49: {
            "text": "Медициналық қызмет көрсету кезінде қандай этикалық талаптар сақталады?",
            "options": {
                "a": "пациенттің құпиясын сақтау",
                "b": "құқықтары мен ерікті келісімін сақтау",
                "c": "дәрігердің кәсіби этикасы",
                "d": "барлық жауаптар дұрыс"
            }
        },
        50: {
            "text": "Қоғамдық денсаулық сақтау жүйесінің басты міндеті қандай?",
            "options": {
                "a": "денсаулық сақтау жүйесінің тиімді жұмысын қамтамасыз ету",
                "b": "пациенттердің құпиясын қорғау",
                "c": "қоғамдық денсаулықты қорғау",
                "d": "барлық жауаптар дұрыс"
            }
        }

    }

    if question not in questions:
        return redirect(url_for('result'))

    if request.method == 'POST':
        answer = request.form.get('answer')
        session[f'q{question}'] = answer
        return redirect(url_for('quiz', question=question + 1))

    return render_template('quiz.html', question_num=question, question=questions[question])


@app.route('/result')
def result():
    if 'username' not in session:
        return redirect(url_for('login'))

    score = 0
    total = 3
    user_answers = {}
    for i in range(1, 4):
        user_answer = session.get(f'q{i}')
        user_answers[f'q{i}'] = {
            'your': user_answer,
            'correct': CORRECT_ANSWERS[f'q{i}'],
            'is_correct': user_answer == CORRECT_ANSWERS[f'q{i}']
        }
        if user_answer == CORRECT_ANSWERS[f'q{i}']:
            score += 1

    username = session['username']
    flash('Quiz completed!', 'info')
    return render_template('result.html', username=username, score=score, total=total, user_answers=user_answers)


@app.route('/logout')
def logout():
    session.clear()
    flash('You have been logged out.', 'warning')
    return redirect(url_for('login'))


@app.route('/try-again')
def try_again():
    for i in range(1, 4):
        session.pop(f'q{i}', None)
    return redirect(url_for('quiz', question=1))


if __name__ == '__main__':
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 80)))
